The lines

    total_times = []
    for batch in batches:
        total_time = trade['CalcSec']
        for key in trade['MarketKeys']:
            total_time += calc_total_time(key, market_keys_dict, batch['CalculatedKeys'])
        total_times.append(total_time)

look wrong as they do not result in total_times being an array of all trades allocated to batches so far plus the additional trade we want to add.

Can you rewrite these lines please?
